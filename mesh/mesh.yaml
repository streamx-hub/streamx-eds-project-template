defaultRegistry: ghcr.io/streamx-dev/streamx-blueprints
defaultImageTag: 2.0.12-jvm

sources:
  github:
    outgoing:
      - "pages"
      - "web-resources"
  eds:
    outgoing:
      - "pages"
      - "web-resources"

ingestion:
  rest-ingestion:
    environmentFrom:
      configs:
        - "ingestion.properties"
    environment:
      # Ensures that generated tokens would work between cluster restarts
      STREAMX_SOURCES_GITHUB_ACCEPT_IAT_FROM: "1704067200"
      STREAMX_SOURCES_EDS_ACCEPT_IAT_FROM: "1704067200"

processing:

  web-resources-relay:
    image: relay-processing-service
    incoming:
      messages:
        topic: inboxes/web-resources
    outgoing:
      relayed-messages:
        topic: relays/web-resources
    environment:
      MP_MESSAGING_INCOMING_MESSAGES_SCHEMA: "web-resource-schema"
      MP_MESSAGING_OUTGOING_RELAYED-MESSAGES_SCHEMA: "web-resource-schema"

  pages-relay:
    image: relay-processing-service
    incoming:
      messages:
        topic: inboxes/pages
    outgoing:
      relayed-messages:
        topic: relays/pages
    environment:
      MP_MESSAGING_INCOMING_MESSAGES_SCHEMA: "page-schema"
      MP_MESSAGING_OUTGOING_RELAYED-MESSAGES_SCHEMA: "page-schema"

  isolated-pages-relay:
    image: relay-processing-service
    incoming:
      messages:
        topic: relays/isolated-pages
    outgoing:
      relayed-messages:
        topic: outboxes/pages
    environment:
      MP_MESSAGING_INCOMING_MESSAGES_SCHEMA: "page-schema"
      MP_MESSAGING_OUTGOING_RELAYED-MESSAGES_SCHEMA: "page-schema"

  pages-deps-rewriter:
    image: external-resources-processing-service
    incoming:
      incoming-pages:
        topic: relays/pages
      incoming-data:
        topic: relays/fake-data-channel
      incoming-web-resources:
        topic: relays/fake-web-resources
    outgoing:
      outgoing-pages:
        topic: relays/isolated-pages
      outgoing-web-resources:
        topic: outboxes/web-resources
      outgoing-assets:
        topic: outboxes/assets
      outgoing-data:
        topic: relays/fake-data-channel
    environment:
      STREAMX_BLUEPRINTS_EXTERNAL_RESOURCES_PROCESSING_SERVICE_BASE_URL_FOR_RELATIVE_PATHS: "${streamx.eds-base.url}"
      STREAMX_BLUEPRINTS_EXTERNAL_RESOURCES_PROCESSING_SERVICE_PROCESSABLE_SX_TYPES: "page/blog,page/blog/external"
      STREAMX_BLUEPRINTS_EXTERNAL_RESOURCES_PROCESSING_SERVICE_HTML_EXTERNAL_RESOURCE_XPATH_SELECTORS: "//img/@src,//link[@rel='stylesheet']/@href,//script/@src,//picture/source/@srcset,//meta[@property='og:image' or @name='twitter:image']/@content"
      STREAMX_BLUEPRINTS_EXTERNAL_RESOURCES_PROCESSING_SERVICE_HTML_EXTERNAL_RESOURCE_URL_EXCLUSIONS_PATTERN: ".*(/blocks/|/fonts/|/icons/|/scripts/|/styles/|helix-query\\.yaml|blog\\.json|index\\.json).*"
      STREAMX_BLUEPRINTS_EXTERNAL_RESOURCES_PROCESSING_SERVICE_EXTERNAL_PAGE_PUBLISH_SX_TYPE: "page/blog/external"
      STREAMX_BLUEPRINTS_EXTERNAL_RESOURCES_PROCESSING_SERVICE_EXTERNAL_WEB_RESOURCE_PUBLISH_SX_TYPE: "web-resource/static/external"

  web-resources-deps-rewriter:
    image: external-resources-processing-service
    incoming:
      incoming-web-resources:
        topic: relays/web-resources
      incoming-pages:
        topic: relays/fake-pages-channel
      incoming-data:
        topic: relays/fake-data-channel
    outgoing:
      outgoing-pages:
        topic: relays/pages
      outgoing-web-resources:
        topic: outboxes/web-resources
      outgoing-assets:
        topic: outboxes/assets
      outgoing-data:
        topic: relays/fake-data-channel
    environment:
      STREAMX_BLUEPRINTS_EXTERNAL_RESOURCES_PROCESSING_SERVICE_BASE_URL_FOR_RELATIVE_PATHS: "${streamx.eds-base.url}"
      STREAMX_BLUEPRINTS_EXTERNAL_RESOURCES_PROCESSING_SERVICE_PROCESSABLE_SX_TYPES: "web-resource/static"
      STREAMX_BLUEPRINTS_EXTERNAL_RESOURCES_PROCESSING_SERVICE_HTML_EXTERNAL_RESOURCE_XPATH_SELECTORS: "//img/@src,//picture/source/@srcset"
      STREAMX_BLUEPRINTS_EXTERNAL_RESOURCES_PROCESSING_SERVICE_XML_EXTERNAL_RESOURCE_XPATH_SELECTORS: "/*[local-name()='urlset']/*[local-name()='url']/*[local-name()='loc']"
      STREAMX_BLUEPRINTS_EXTERNAL_RESOURCES_PROCESSING_SERVICE_JSON_EXTERNAL_RESOURCE_JSONPATH_SELECTORS: "$.data[*].image"
      STREAMX_BLUEPRINTS_EXTERNAL_RESOURCES_PROCESSING_SERVICE_EXTERNAL_PAGE_PUBLISH_SX_TYPE: "page/blog/external"
      STREAMX_BLUEPRINTS_EXTERNAL_RESOURCES_PROCESSING_SERVICE_EXTERNAL_WEB_RESOURCE_PUBLISH_SX_TYPE: "web-resource/static/external"

  sitemap-generator:
    image: sitemap-generator-processing-service
    incoming:
      incoming-pages:
        topic: relays/isolated-pages
    outgoing:
      outgoing-sitemaps:
        topic: outboxes/web-resources
    environment:
      STREAMX_BLUEPRINTS_SITEMAP-GENERATOR-PROCESSING-SERVICE_BASE-URL: "${streamx.eds-template.web.url}"
      STREAMX_BLUEPRINTS_SITEMAP-GENERATOR-PROCESSING-SERVICE_OUTPUT-KEY: "/sitemap.xml"
      STREAMX_BLUEPRINTS_SITEMAP-GENERATOR-PROCESSING-SERVICE_OUTPUT-TYPE: "web-resource/sitemap"

  eds-index-fetcher:
    image: scheduled-resource-processing-service
    incoming:
      scheduling-triggers:
        topic: inboxes/web-resources
    outgoing:
      fetched-resources:
        topic: relays/web-resources
    environment:
      STREAMX_BLUEPRINTS_SCHEDULED-RESOURCE-PROCESSING-SERVICE_FETCHER: "eds"
      STREAMX_BLUEPRINTS_SCHEDULED-RESOURCE-PROCESSING-SERVICE_EDS_ENDPOINT_URL: "${streamx.eds-base.url}"
      STREAMX_BLUEPRINTS_SCHEDULED-RESOURCE-PROCESSING-SERVICE_EDS_RESOURCE_NAME_PATTERN: "helix-query.yaml"
      STREAMX_BLUEPRINTS_SCHEDULED-RESOURCE-PROCESSING-SERVICE_OUTPUT_TYPE: "web-resource/static"

delivery:
  web-server:
    image: web-delivery-service
    incoming:
      pages:
        topic: outboxes/pages
      assets:
        topic: outboxes/assets
      web-resources:
        topic: outboxes/web-resources
      fragments:
        topic: outboxes/fragments
    environment:
      STREAMX_BLUEPRINTS_WEB-DELIVERY-SERVICE_RESOURCES_DIRECTORY: "/srv/www"
      STREAMX_URL-INCLUDE-REPLACEMENT-PROVIDER_SSI-INCLUDE-FALLBACK-CONTENT: "<!-- Include Not Found -->"
    repositoryVolume: "/srv/www"
    port: 8083
    components:
      webserver:
        image: "registry.streamx.cloud/streamx-docker-hub-public-proxy/library/nginx:1.26.0"
        ports:
          - 8084:80
        repositoryVolume: "/usr/share/nginx/html"
        volumesFrom:
          configs:
            - "nginx_conf/demo.conf:/etc/nginx/conf.d/default.conf"
